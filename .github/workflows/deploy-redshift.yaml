name: Deploy Redshift CDK

on:
  workflow_dispatch:
    inputs:
      tenant:
        description: 'Tenant name'
        required: true
        default: carefirst
      env:
        description: 'Environment name (dev/prod)'
        required: true
        default: dev

jobs:
  deploy-redshift:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        npm install -g aws-cdk

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::375299851423:role/your-github-actions-deploy-role
        aws-region: us-east-1

    - name: Export environment variables
      run: |
        echo "TENANT=${{ github.event.inputs.tenant }}" >> $GITHUB_ENV
        echo "ENV_NAME=${{ github.event.inputs.env }}" >> $GITHUB_ENV

    - name: Bootstrap CDK (if needed)
      run: |
        cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION

    - name: Deploy Redshift stack
      run: |
        cdk deploy -c tenant=$TENANT -c env=$ENV_NAME --require-approval never
